# H·ªá th·ªëng ph√¢n quy·ªÅn ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u

## üöÄ **T·ªêI ∆ØU ƒê√É TH·ª∞C HI·ªÜN**

### ‚úÖ **Tr∆∞·ªõc khi t·ªëi ∆∞u:**
- useAuthGuard ch·∫°y trong `onBeforeMount` ‚Üí Trang load xong m·ªõi ki·ªÉm tra quy·ªÅn
- Ng∆∞·ªùi d√πng th·∫•y trang tr∆∞·ªõc khi b·ªã chuy·ªÉn h∆∞·ªõng
- Tr·∫£i nghi·ªám kh√¥ng m∆∞·ª£t m√†

### ‚úÖ **Sau khi t·ªëi ∆∞u:**
- Router Guard ki·ªÉm tra quy·ªÅn **TR∆Ø·ªöC KHI** t·∫£i trang
- Ng∆∞·ªùi d√πng kh√¥ng th·∫•y trang n·∫øu kh√¥ng c√≥ quy·ªÅn
- Chuy·ªÉn th·∫≥ng ƒë·∫øn trang l·ªói 401/403

---

## üìã **C√ÅC TH√ÄNH PH·∫¶N M·ªöI**

### 1. **Router Guard** (`/router/guards.js`)
- Ki·ªÉm tra quy·ªÅn tr∆∞·ªõc khi t·∫£i component
- Cache permissions ƒë·ªÉ t·ªëi ∆∞u hi·ªáu su·∫•t
- T·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang l·ªói

### 2. **Permission Utils** (`/utils/permissionUtils.js`)
- Centralized permission management
- Cache permissions 5 ph√∫t
- Helper functions cho permission check

### 3. **Error Pages**
- `/pages/errors/401.vue` - Ch∆∞a ƒëƒÉng nh·∫≠p
- `/pages/errors/403.vue` - Kh√¥ng c√≥ quy·ªÅn

### 4. **Router Meta**
```javascript
{
    path: 'admin/users',
    meta: { 
        requiresAuth: true, 
        requiredPermissions: ['user.view'] 
    }
}
```

---

## üõ†Ô∏è **C√ÅCH S·ª¨ D·ª§NG M·ªöI**

### **1. B·∫£o v·ªá Routes (Recommend):**
```javascript
// router/admin.js
{
    path: 'nguoi-dung',
    name: 'admin-user',
    component: () => import('../pages/admins/accounts/user.vue'),
    meta: { 
        requiresAuth: true, 
        requiredPermissions: ['user'] 
    }
}
```

### **2. B·∫£o v·ªá UI Elements:**
```vue
<template>
    <!-- Ki·ªÉm tra quy·ªÅn trong template -->
    <div v-if="hasPermission('user')">
        <button>Th√™m User</button>
    </div>
    
    <!-- V·ªõi multiple permissions -->
    <div v-if="hasAllPermissions(['user', 'staff'])">
        <AdminPanel />
    </div>
</template>
```

### **3. Ki·ªÉm tra quy·ªÅn trong component:**
```vue
<script setup>
import { getUserPermissions, hasAllPermissions } from '@/utils/permissionUtils'

const permissions = await getUserPermissions()
const canEdit = hasAllPermissions(permissions, ['user'])
</script>
```

---

## üîß **C√ÅC API ƒê√É ƒê∆Ø·ª¢C PH√ÇN QUY·ªÄN**

### **User Management:**
- `user` - Qu·∫£n l√Ω ng∆∞·ªùi d√πng
- `staff` - Qu·∫£n l√Ω nh√¢n vi√™n

### **Product Management:**
- `product` - Qu·∫£n l√Ω s·∫£n ph·∫©m
- `category` - Qu·∫£n l√Ω danh m·ª•c
- `attribute` - Qu·∫£n l√Ω thu·ªôc t√≠nh

### **Shop Management:**
- `shop` - Qu·∫£n l√Ω c·ª≠a h√†ng

### **System Management:**
- `role` - Qu·∫£n l√Ω vai tr√≤
- `setting` - C·∫•u h√¨nh h·ªá th·ªëng
- `dashboard` - Dashboard qu·∫£n tr·ªã
- `finance` - Qu·∫£n l√Ω t√†i ch√≠nh
- `voucher` - Qu·∫£n l√Ω m√£ gi·∫£m gi√°
- `rank` - Qu·∫£n l√Ω h·∫°ng th√†nh vi√™n

---

## üéØ **WORKFLOW M·ªöI**

```
User truy c·∫≠p /admin/users
        ‚Üì
Router Guard ki·ªÉm tra token
        ‚Üì
Ki·ªÉm tra meta.requiredPermissions
        ‚Üì
G·ªçi API /role/user (c√≥ cache)
        ‚Üì
So s√°nh quy·ªÅn y√™u c·∫ßu vs quy·ªÅn user
        ‚Üì
‚úÖ C√≥ quy·ªÅn: Load component
‚ùå Kh√¥ng c√≥ quy·ªÅn: Chuy·ªÉn ƒë·∫øn /forbidden
‚ùå Ch∆∞a login: Chuy·ªÉn ƒë·∫øn /unauthorized
```

---

## üìù **L∆ØU √ù**

1. **useAuthGuard c≈© ƒë√£ deprecated** - S·ª≠ d·ª•ng router meta thay th·∫ø
2. **Cache permissions** - T·ª± ƒë·ªông expire sau 5 ph√∫t
3. **Clear cache khi logout** - G·ªçi `clearAuthCache()`
4. **Error pages responsive** - T·ª± ƒë·ªông responsive tr√™n mobile

---

## üß™ **TESTING**

1. **Test kh√¥ng c√≥ token:**
   - Truy c·∫≠p `/admin` ‚Üí Chuy·ªÉn `/unauthorized`

2. **Test kh√¥ng c√≥ quy·ªÅn:**
   - Login user kh√¥ng c√≥ quy·ªÅn admin
   - Truy c·∫≠p `/admin/users` ‚Üí Chuy·ªÉn `/forbidden`

3. **Test c√≥ quy·ªÅn:**
   - Login admin
   - Truy c·∫≠p `/admin/users` ‚Üí Load b√¨nh th∆∞·ªùng

**üéâ H·ªá th·ªëng b√¢y gi·ªù s·∫Ω ki·ªÉm tra quy·ªÅn TR∆Ø·ªöC KHI t·∫£i trang, kh√¥ng c√≤n hi·ªán trang r·ªìi m·ªõi chuy·ªÉn h∆∞·ªõng!**

---

## üîç **C√ÅCH HO·∫†T ƒê·ªòNG CHI TI·∫æT**

### **1. Ki·∫øn tr√∫c h·ªá th·ªëng ph√¢n quy·ªÅn**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend      ‚îÇ    ‚îÇ    Backend      ‚îÇ    ‚îÇ   Database      ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ Router Guards ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ ‚Ä¢ Middleware    ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ ‚Ä¢ tbl_users     ‚îÇ
‚îÇ ‚Ä¢ Permission    ‚îÇ    ‚îÇ ‚Ä¢ Controllers   ‚îÇ    ‚îÇ ‚Ä¢ tbl_roles     ‚îÇ
‚îÇ   Utils         ‚îÇ    ‚îÇ ‚Ä¢ Models        ‚îÇ    ‚îÇ ‚Ä¢ tbl_permissions‚îÇ
‚îÇ ‚Ä¢ Auth State    ‚îÇ    ‚îÇ ‚Ä¢ Sanctum       ‚îÇ    ‚îÇ ‚Ä¢ tbl_role_perms‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **2. Database Schema**

```sql
-- B·∫£ng vai tr√≤
tbl_roles
‚îú‚îÄ‚îÄ id (PK)
‚îú‚îÄ‚îÄ title (unique)         -- 'admin', 'staff', 'user'
‚îú‚îÄ‚îÄ description           -- M√¥ t·∫£ vai tr√≤
‚îú‚îÄ‚îÄ role_status          -- Tr·∫°ng th√°i ho·∫°t ƒë·ªông
‚îî‚îÄ‚îÄ timestamps

-- B·∫£ng quy·ªÅn
tbl_permissions  
‚îú‚îÄ‚îÄ id (PK)
‚îú‚îÄ‚îÄ title (unique)         -- 'user', 'product', 'shop'
‚îú‚îÄ‚îÄ description           -- M√¥ t·∫£ quy·ªÅn
‚îî‚îÄ‚îÄ timestamps

-- B·∫£ng ph√¢n quy·ªÅn (Many-to-Many)
tbl_role_permissions
‚îú‚îÄ‚îÄ id (PK)
‚îú‚îÄ‚îÄ role_id (FK ‚Üí tbl_roles.id)
‚îú‚îÄ‚îÄ permission_id (FK ‚Üí tbl_permissions.id)
‚îú‚îÄ‚îÄ permission_value      -- 1: c√≥ quy·ªÅn, 0: kh√¥ng c√≥ quy·ªÅn
‚îî‚îÄ‚îÄ timestamps

-- B·∫£ng ng∆∞·ªùi d√πng
tbl_users
‚îú‚îÄ‚îÄ id (PK)
‚îú‚îÄ‚îÄ user_name
‚îú‚îÄ‚îÄ email
‚îú‚îÄ‚îÄ password
‚îú‚îÄ‚îÄ role_id (FK ‚Üí tbl_roles.id, nullable)
‚îî‚îÄ‚îÄ ... other fields
```

### **3. Backend Security Flow**

#### **3.1 PermissionMiddleware.php**
```php
public function handle(Request $request, Closure $next, ...$permissions)
{
    $user = Auth::user();
    
    // 1. Ki·ªÉm tra ƒëƒÉng nh·∫≠p
    if (!$user) {
        return response()->json(['message' => 'Unauthorized'], 401);
    }

    // 2. Ki·ªÉm tra role_id cho admin routes  
    if ($request->is('api/admin/*') && !$user->role_id) {
        return response()->json([
            'message' => 'Forbidden',
            'error' => 'no_role'
        ], 403);
    }

    // 3. L·∫•y quy·ªÅn c·ªßa user t·ª´ database
    $userPermissions = RolePermission::where('role_id', $user->role_id)
        ->where('permission_value', 1)
        ->with('permission')
        ->get()
        ->pluck('permission.title')
        ->toArray();

    // 4. Ki·ªÉm tra quy·ªÅn y√™u c·∫ßu
    foreach ($permissions as $permission) {
        if (!in_array($permission, $userPermissions)) {
            return response()->json([
                'message' => 'Forbidden',
                'required_permission' => $permission
            ], 403);
        }
    }

    return $next($request);
}
```

#### **3.2 Route Protection**
```php
// routes/user.php
Route::middleware(['auth:sanctum', 'permission:user|staff'])->group(function () {
    Route::get('/user-list', [UserController::class, 'getUsers']);
    Route::post('/user/change-status/{id}', [UserController::class, 'changeStatus']);
});

// routes/role.php  
Route::middleware(['auth:sanctum', 'permission:role'])->group(function () {
    Route::get('/role', [RoleController::class, 'getRoles']);
    Route::post('/role', [RoleController::class, 'store']);
});

// routes/shop.php
Route::middleware(['auth:sanctum', 'permission:shop'])->group(function () {
    Route::get('shops', [ShopController::class, 'getShops']);
    Route::post('shop/change-status/{id}', [ShopController::class, 'changeStatus']);
});
```

### **4. Frontend Security Flow**

#### **4.1 Router Guard Process**
```javascript
// router/guards.js
export async function routeGuard(to, from, next) {
    const token = localStorage.getItem('token')
    
    // B∆Ø·ªöC 1: Ki·ªÉm tra requiresAuth
    if (!to.meta?.requiresAuth) {
        return next() // Route c√¥ng khai ‚Üí OK
    }
    
    // B∆Ø·ªöC 2: Ki·ªÉm tra token
    if (!token) {
        return next({
            name: 'unauthorized',
            query: { redirect: to.fullPath }
        })
    }
    
    // B∆Ø·ªöC 3: Ki·ªÉm tra ƒë·∫∑c bi·ªát cho admin routes
    if (to.path.startsWith('/admin')) {
        try {
            const role = await getUserRole()
            if (!role || !role.id) {
                return next({
                    name: 'forbidden',
                    query: { reason: 'no_role' }
                })
            }
        } catch (error) {
            return next({ name: 'unauthorized' })
        }
    }
    
    // B∆Ø·ªöC 4: Ki·ªÉm tra permissions c·ª• th·ªÉ
    if (!to.meta?.requiredPermissions?.length) {
        return next() // Kh√¥ng y√™u c·∫ßu permission ‚Üí OK
    }
    
    try {
        const permissions = await getUserPermissions()
        const hasRequired = hasAllPermissions(permissions, to.meta.requiredPermissions)
        
        if (hasRequired) {
            return next() // C√≥ ƒë·ªß quy·ªÅn ‚Üí OK
        } else {
            return next({
                name: 'forbidden',
                query: { required: to.meta.requiredPermissions.join(',') }
            })
        }
    } catch (error) {
        return next({ name: 'unauthorized' })
    }
}
```

#### **4.2 Permission Caching**
```javascript
// utils/permissionUtils.js
let permissionsCache = null
let roleCache = null  
let cacheExpiry = 0
const CACHE_DURATION = 5 * 60 * 1000 // 5 ph√∫t

export async function getUserPermissions() {
    const now = Date.now()
    
    // Ki·ªÉm tra cache c√≤n hi·ªáu l·ª±c kh√¥ng
    if (permissionsCache && now < cacheExpiry) {
        return permissionsCache
    }
    
    // G·ªçi API l·∫•y permissions m·ªõi
    const response = await api.get('/role/user')
    const permissions = response.data.permissions.map(p => p.title)
    
    // C·∫≠p nh·∫≠t cache
    permissionsCache = permissions
    cacheExpiry = now + CACHE_DURATION
    
    return permissions
}
```

### **5. Authentication State Management**

#### **5.1 Global Auth State**
```javascript
// utils/authState.js
const user_name_auth = ref(localStorage.getItem('user_name') || '')
const avatar_user = ref(localStorage.getItem('avatar') || '')
const user_role = ref(JSON.parse(localStorage.getItem('role') || 'null'))

// Sync v·ªõi localStorage
watch(user_role, (newVal) => {
    if (newVal) {
        localStorage.setItem('role', JSON.stringify(newVal))
    } else {
        localStorage.removeItem('role')
    }
})

// Clear khi logout
const clear_user = () => {
    user_name_auth.value = ""
    avatar_user.value = ""
    user_role.value = null
    
    ['user_name', 'avatar', 'token', 'role'].forEach(key => {
        localStorage.removeItem(key)
    })
}
```

### **6. Error Handling & User Experience**

#### **6.1 Error Pages**
```vue
<!-- pages/errors/401.vue -->
<template>
    <div class="error-page unauthorized-page">
        <div class="error-container">
            <h1 class="error-code">401</h1>
            <h2>Ch∆∞a ƒëƒÉng nh·∫≠p</h2>
            <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p khu v·ª±c n√†y</p>
            
            <div class="error-actions">
                <button @click="goToLogin">ƒêƒÉng nh·∫≠p ngay</button>
                <button @click="goHome">V·ªÅ trang ch·ªß</button>
            </div>
        </div>
    </div>
</template>
```

```vue
<!-- pages/errors/403.vue -->
<template>
    <div class="error-page forbidden-page">
        <div class="error-container">
            <h1 class="error-code">403</h1>
            <h2>Truy c·∫≠p b·ªã t·ª´ ch·ªëi</h2>
            
            <!-- Ph√¢n bi·ªát l·ªói: No Role vs No Permission -->
            <div v-if="isNoRoleError" class="no-role">
                <p>T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c c·∫•p vai tr√≤ ƒë·ªÉ truy c·∫≠p khu v·ª±c qu·∫£n tr·ªã</p>
            </div>
            
            <div v-else class="no-permission">
                <p>B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y</p>
                <div v-if="requiredPermissions">
                    <strong>Quy·ªÅn y√™u c·∫ßu:</strong> {{ requiredPermissions }}
                </div>
            </div>
        </div>
    </div>
</template>
```

### **7. Performance Optimizations**

#### **7.1 API Caching v·ªõi useConfig**
```javascript
// composables/useConfig.js
const configData = ref(null)
const lastFetch = ref(null)
const CACHE_DURATION = 5 * 60 * 1000

export function useConfig() {
    const isCacheValid = computed(() => {
        return configData.value && 
               lastFetch.value && 
               Date.now() - lastFetch.value < CACHE_DURATION
    })
    
    const fetchConfig = async (force = false) => {
        if (!force && isCacheValid.value) {
            return configData.value // S·ª≠ d·ª•ng cache
        }
        
        // Tr√°nh duplicate calls
        if (isLoading.value) {
            return new Promise((resolve) => {
                const interval = setInterval(() => {
                    if (!isLoading.value && configData.value) {
                        clearInterval(interval)
                        resolve(configData.value)
                    }
                }, 100)
            })
        }
        
        // Fetch t·ª´ API
        const res = await api.get('/config')
        configData.value = res.data.config
        lastFetch.value = Date.now()
        
        return configData.value
    }
}
```

### **8. Security Best Practices**

1. **Double Protection**: Frontend + Backend validation
2. **Token-based Auth**: Sanctum cho API security  
3. **Role Hierarchy**: Admin > Staff > User
4. **Permission Granularity**: Specific permissions cho t·ª´ng module
5. **Cache Security**: Auto-expire v√† clear on logout
6. **Route Meta**: Declarative permission requirements
7. **Error Disclosure**: Limited information trong error messages

### **9. Workflow Complete**

```
üåê User Request ‚Üí üîê Frontend Guard ‚Üí üõ°Ô∏è Backend Middleware ‚Üí üíæ Database Check ‚Üí ‚úÖ Access Granted
                      ‚Üì FAIL             ‚Üì FAIL              ‚Üì FAIL
                   üìÑ Error Page      üö´ 403 Response    ‚ùå Permission Denied
```

### **10. Real Example Flow**

```
V√≠ d·ª•: User truy c·∫≠p /admin/nguoi-dung

1. Router Guard nh·∫≠n request
2. Ki·ªÉm tra to.meta.requiresAuth = true
3. Ki·ªÉm tra localStorage.getItem('token') = c√≥ token
4. Ki·ªÉm tra to.path.startsWith('/admin') = true
5. G·ªçi getUserRole() ‚Üí ki·ªÉm tra role_id ‚â† null
6. Ki·ªÉm tra to.meta.requiredPermissions = ['user'] 
7. G·ªçi getUserPermissions() ‚Üí ['user', 'staff', 'dashboard']
8. hasAllPermissions(['user', 'staff', 'dashboard'], ['user']) = true
9. next() ‚Üí Load component AdminUser.vue
```

**H·ªá th·ªëng n√†y ƒë·∫£m b·∫£o security ·ªü m·ªçi layer v√† cung c·∫•p UX m∆∞·ª£t m√† cho ng∆∞·ªùi d√πng!**
